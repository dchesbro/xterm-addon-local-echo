function t(){return t=Object.assign?Object.assign.bind():function(t){for(var i=1;i<arguments.length;i++){var e=arguments[i];for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&(t[s]=e[s])}return t},t.apply(this,arguments)}function i({onlyFirst:t=!1}={}){const i=["[\\u001B\\u009B][[\\]()#;?]*(?:(?:(?:(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]+)*|[a-zA-Z\\d]+(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]*)*)?\\u0007)","(?:(?:\\d{1,4}(?:;\\d{0,4})*)?[\\dA-PR-TZcf-ntqry=><~]))"].join("|");return new RegExp(i,t?void 0:"g")}class e{constructor(t){this.index=0,this.sizeMax=void 0,this.items=[],this.sizeMax=t}getPrev(){return this.index=Math.max(0,this.index-1),this.items[this.index]}getNext(){return this.index=Math.min(this.items.length,this.index+1),this.items[this.index]}push(t){""!==t.trim()&&(t!==this.items[this.items.length-1]&&(this.items.push(t),this.items.length>this.sizeMax&&this.items.shift()),this.rewind())}rewind(){this.index=this.items.length}}for(var s="(?:"+["\\|\\|","\\&\\&",";;","\\|\\&","\\<\\(","\\<\\<\\<",">>",">\\&","<\\&","[&;()|<>]"].join("|")+")",r="|&;()<> \\t",n="(\\\\['\""+r+"]|[^\\s'\""+r+"])+",h="",l=0;l<4;l++)h+=(Math.pow(16,8)*Math.random()).toString(16);var o=function(t,i,e){var r=function(t,i,e){var r=new RegExp(["("+s+")","("+n+"|\"((\\\\\"|[^\"])*?)\"|'((\\\\'|[^'])*?)')*"].join("|"),"g"),l=t.match(r).filter(Boolean);if(!l)return[];i||(i={}),e||(e={});var o=!1;return l.map(function(t,r){if(!o){if(RegExp("^"+s+"$").test(t))return{op:t};var n,a=e.escape||"\\",c=!1,u=!1,p="",m=!1;for(n=0;n<t.length;n++){var d=t.charAt(n);if(m=m||!c&&("*"===d||"?"===d),u)p+=d,u=!1;else if(c)d===c?c=!1:p+="'"==c?d:d===a?'"'===(d=t.charAt(n+=1))||d===a||"$"===d?d:a+d:"$"===d?f():d;else if('"'===d||"'"===d)c=d;else{if(RegExp("^"+s+"$").test(d))return{op:t};if(/^#$/.test(d))return o=!0,p.length?[p,{comment:t.slice(n+1)+l.slice(r+1).join(" ")}]:[{comment:t.slice(n+1)+l.slice(r+1).join(" ")}];d===a?u=!0:p+="$"===d?f():d}}return m?{op:"glob",pattern:p}:p}function f(){var e,s,r,l;if("{"===t.charAt(n+=1)){if("}"===t.charAt(n+=1))throw new Error("Bad substitution: "+t.substr(n-2,3));if((e=t.indexOf("}",n))<0)throw new Error("Bad substitution: "+t.substr(n));s=t.substr(n,e-n),n=e}else/[*@#?$!_-]/.test(t.charAt(n))?(s=t.charAt(n),n+=1):(e=t.substr(n).match(/[^\w\d_]/))?(s=t.substr(n,e.index),n+=e.index-1):(s=t.substr(n),n=t.length);return r=s,void 0===(l="function"==typeof i?i(r):i[r])&&""!=r?l="":void 0===l&&(l="$"),"object"==typeof l?""+h+JSON.stringify(l)+h:""+l}}).reduce(function(t,i){return void 0===i?t:t.concat(i)},[])}(t,i,e);return"function"!=typeof i?r:r.reduce(function(t,i){if("object"==typeof i)return t.concat(i);var e=i.split(RegExp("("+h+".*?"+h+")","g"));return t.concat(1===e.length?e[0]:e.filter(Boolean).map(function(t){return RegExp("^"+h).test(t)?JSON.parse(t.split(h)[1]):t}))},[])};function a(t,i,e){let s=0,r=0;for(let n=0;n<i;n++)"\n"===t.charAt(n)?(s=0,r++):(s++,s===e&&(s=0,r++));return{col:s,row:r}}function c(t){return""===t.trim()||d(t)?"":o(t).pop()||""}function u(t,e){return a(t,t.replace(i(),"").length,e).row+1}function p(t,i){if(t.length>=i[0].length)return t;const e=t;t+=i[0].slice(t.length,t.length+1);for(let s=0;s<i.length;s++){if(!i[s].startsWith(e))return null;if(!i[s].startsWith(t))return e}return p(t,i)}function m(t,i,e){const s=[],r=/\w+/g;let n,h;for(;h=r.exec(t);)s.push(h.index);return n=e?s.reverse().find(t=>t<i)||0:s.find(t=>t>i)||t.length,n}function d(t){return null!==t.match(/[^\\][ \t]$/m)}class f{constructor(t){var i,s,r;this.terminal=void 0,this.disposables=[],this.active=!1,this.activePrompt=null,this.activePromptChar=null,this.cursor=0,this.incompleteEnabled=void 0,this.input="",this.tabCompleteHandlers=[],this.tabCompleteSize=void 0,this.terminalSize={cols:0,rows:0},this.history=void 0,this.history=new e(null!=(i=null==t?void 0:t.historySize)?i:10),this.incompleteEnabled=null==(s=null==t?void 0:t.incompleteEnabled)||s,this.tabCompleteSize=null!=(r=null==t?void 0:t.tabCompleteSize)?r:10}attach(){this.terminal&&(this.disposables.push(this.terminal.onData(t=>this.handleTermData(t))),this.disposables.push(this.terminal.onResize(t=>this.handleTermResize(t))),this.terminalSize={cols:this.terminal.cols,rows:this.terminal.rows})}detach(){this.disposables.forEach(t=>t.dispose()),this.disposables=[]}activate(t){this.terminal=t,this.attach()}dispose(){this.detach()}async read(t="$ ",i="> "){return new Promise((e,s)=>{this.terminal.write(t),this.active=!0,this.activePrompt={ps1:t,ps2:i,resolve:e,reject:s},this.cursor=0,this.input=""})}async readChar(t){return new Promise((i,e)=>{this.terminal.write(t),this.activePromptChar={ps1:t,ps2:"",resolve:i,reject:e}})}readAbort(t="READINT"){null===this.activePrompt&&null===this.activePromptChar||this.terminal.write("\r\n"),null!==this.activePrompt&&(this.activePrompt.reject(t),this.activePrompt=null),null!==this.activePromptChar&&(this.activePromptChar.reject(t),this.activePromptChar=null),this.active=!1}print(t){const i=t.replace(/[\r\n]+/g,"\n");this.terminal.write(i.replace(/\n/g,"\r\n"))}println(t){this.print(t+"\n")}printlsInline(t,i=3){if(0===t.length)return;const e=t.reduce((t,i)=>Math.max(t,i.length),0);let s="";for(let r=0;r<t.length;r++){let n=t[r].padEnd(e+i," ");s.length+n.length>this.terminalSize.cols&&(this.println(s),s=""),s+=n}this.println(s)}printlsNumber(t,i=3){if(0===t.length)return;const e=t.length.toString().length;for(let s=0;s<t.length;s++)this.println(`${s+1}`.padEnd(i," ").padStart(e," ")+t[s])}addTabCompleteHandler(t,...i){this.tabCompleteHandlers.push({callback:t,args:i})}removeTabCompleteHandler(t){const i=this.tabCompleteHandlers.findIndex(i=>i.callback===t);-1!==i&&this.tabCompleteHandlers.splice(i,1)}applyPrompt(i){const e=t({},{ps1:"",ps2:""},this.activePrompt);return e.ps1+i.replace(/\n/g,"\n"+e.ps2)}applyPromptComplete(t){const i=this.cursor;this.setCursor(this.input.length),this.terminal.write("\r\n");const e=()=>{this.cursor=i,this.setInput(this.input)},s=t();null==s?e():s.then(e)}applyPromptOffset(t,e){return this.applyPrompt(t.substring(0,e)).replace(i(),"").length}clearInput(){const t=this.applyPrompt(this.input),i=this.applyPromptOffset(this.input,t.length),{row:e}=a(t,i,this.terminalSize.cols),s=u(t,this.terminalSize.cols),r=s-(e+1);for(let t=0;t<r;t++)this.terminal.write("[E");this.terminal.write("\r[K");for(let t=1;t<s;t++)this.terminal.write("[F[K")}handleCursorInsert(t){this.cursor+=t.length,this.setInput(this.input.substring(0,this.cursor)+t+this.input.substring(this.cursor))}handleCursorMove(t){if(t>0){const i=Math.min(t,this.input.length-this.cursor);this.setCursor(this.cursor+i)}else if(t<0){const i=Math.max(t,-1*this.cursor);this.setCursor(this.cursor+i)}}handleCursorErase(t){t&&this.cursor>0&&(this.cursor-=1),this.setInput(this.input.substring(0,this.cursor)+this.input.substring(this.cursor+1))}handleData(i){if(!this.active)return;const e=i.charCodeAt(0);if(27==e)switch(i.substring(1)){case"[A":if(this.history){const t=this.history.getPrev();t&&(this.setInput(t),this.setCursor(t.length))}break;case"[B":if(this.history){const t=this.history.getNext()||"";this.setInput(t),this.setCursor(t.length)}break;case"[3~":this.handleCursorErase(!1);break;case"":{const t=m(this.input,this.cursor,!0),i=m(this.input,t,!1);this.setInput(this.input.substring(0,t)+this.input.substring(i)),this.setCursor(t);break}}else if(e<32||127===e)switch(i){case"\r":this.incompleteEnabled?function(t){if(t.trim()){var i;if((t.match(/'/g)||[]).length%2!=0)return!0;if((t.match(/"/g)||[]).length%2!=0)return!0;if(""===(null==(i=t.split(/(\|\||\||&&)/g).pop())?void 0:i.trim()))return!0;if(t.endsWith("\\")&&!t.endsWith("\\\\"))return!0}return!1}(this.input)&&this.handleCursorInsert("\n"):this.handleReadComplete();break;case"":this.handleCursorErase(!0);break;case"\t":if(this.tabCompleteHandlers.length){const t=this.input.substring(0,this.cursor),i=function(t,i){const e=o(i);let s=e.length-1,r=e[s]||"";return""===i.trim()?(s=0,r=""):d(i)&&(s+=1,r=""),t.reduce((t,{callback:i,args:r})=>{try{return t.concat(i(s,e,...r))}catch(i){return console.error("Tab complete error:",i),t}},[]).filter(t=>t.startsWith(r)).sort()}(this.tabCompleteHandlers,t),e=d(t);if(i.sort(),0===i.length)e||this.handleCursorInsert(" ");else if(1===i.length){const e=c(t);this.handleCursorInsert(i[0].substring(e.length)+" ")}else if(i.length<=this.tabCompleteSize){const e=p(t,i);if(e){const i=c(t);this.handleCursorInsert(e.substring(i.length))}this.applyPromptComplete(()=>{this.printlsInline(i)})}else this.applyPromptComplete(()=>this.readChar(`Do you wish to see all ${i.length} possibilities? (y/n) `).then(t=>{"y"!==t&&"Y"!==t||this.printlsInline(i)}))}else this.handleCursorInsert("    ");break;case"":const i=t({},{ps1:"",ps2:""},this.activePrompt);this.setCursor(this.input.length),this.terminal.write("^C\r\n"+i.ps1),this.cursor=0,this.input="",this.history&&this.history.rewind()}else this.handleCursorInsert(i)}handleReadComplete(){this.history&&this.history.push(this.input),this.activePrompt&&(this.activePrompt.resolve(this.input),this.activePrompt=null),this.terminal.write("\r\n"),this.active=!1}handleTermData(t){if(this.active){if(null!==this.activePromptChar)return this.activePromptChar.resolve(t),this.activePromptChar=null,this.terminal.write("\r\n");if(t.length>3&&27!==t.charCodeAt(0)){const i=t.replace(/[\r\n]+/g,"\r");Array.from(i).forEach(t=>this.handleData(t))}else this.handleData(t)}}handleTermResize(t){this.clearInput(),this.terminalSize=t,this.setInput(this.input,!1)}setCursor(t){t<0&&(t=0),t>this.input.length&&(t=this.input.length);const i=this.applyPrompt(this.input),e=this.applyPromptOffset(this.input,this.cursor),{col:s,row:r}=a(i,e,this.terminalSize.cols),n=this.applyPromptOffset(this.input,t),{col:h,row:l}=a(i,n,this.terminalSize.cols);if(l>r)for(let t=r;t<l;++t)this.terminal.write("[B");else for(let t=l;t<r;++t)this.terminal.write("[A");if(h>s)for(let t=s;t<h;++t)this.terminal.write("[C");else for(let t=h;t<s;++t)this.terminal.write("[D");this.cursor=t}async setInput(t,i=!0){i&&this.clearInput(),this.cursor>t.length&&(this.cursor=t.length);const e=this.applyPromptOffset(t,this.cursor),s=this.applyPrompt(t);this.print(s);const{col:r,row:n}=a(s,e,this.terminalSize.cols),h=s.substring(e).length;h?e%this.terminalSize.cols+h===this.terminalSize.cols&&this.terminal.write("[E"):0!==n&&0===r&&this.terminal.write("[E");const l=u(s,this.terminalSize.cols)-(n+1);this.terminal.write("\r");for(let t=0;t<l;t++)this.terminal.write("[F");for(let t=0;t<r;t++)this.terminal.write("[C");this.input=t}}export{f as LocalEchoAddon};
//# sourceMappingURL=xterm-addon-local-echo.modern.js.map
